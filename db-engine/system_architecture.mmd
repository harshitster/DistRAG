graph TB
    %% Core Components
    subgraph "DB Engine"
        DBInit[DB Initializer<br/>db-init.py<br/>Schema Setup]
        ChangeListener[Change Listener<br/>change_listener.py<br/>PostgreSQL Notifications]
        Notifier[Notifier<br/>notifier.py<br/>Event Broadcaster]
    end

    %% Database
    subgraph "Citus Cluster"
        Coordinator[PostgreSQL Coordinator<br/>with Event Triggers]
    end

    %% External Systems
    CacheEngine[Cache Engine<br/>Selective Invalidation]
    LLMEngines[AI Engines<br/>Pipeline Rebuild]

    %% Flow
    DBInit -->|Initialize Schema & Triggers| Coordinator
    Coordinator -->|LISTEN/NOTIFY| ChangeListener
    ChangeListener -->|Parse Events| Notifier
    
    %% Notification Types
    Notifier -->|Data Changes<br/>Selective Cache Flush| CacheEngine
    Notifier -->|Schema Changes<br/>Full Rebuild| LLMEngines
    Notifier -->|Schema Changes<br/>Flush All Cache| CacheEngine

    %% Event Types
    subgraph "Event Handling"
        DataChange[Data Change Event<br/>Partition-specific]
        SchemaChange[Schema Change Event<br/>System-wide]
    end

    ChangeListener --> DataChange
    ChangeListener --> SchemaChange
    DataChange --> CacheEngine
    SchemaChange --> LLMEngines
    SchemaChange --> CacheEngine

    %% Styling
    classDef dbengine fill:#e3f2fd
    classDef database fill:#f3e5f5
    classDef external fill:#e8f5e8
    classDef events fill:#fff3e0

    class DBInit,ChangeListener,Notifier dbengine
    class Coordinator database
    class CacheEngine,LLMEngines external
    class DataChange,SchemaChange events